<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Plaid Link — One-time Connect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; }
    .card { max-width: 720px; padding: 1.25rem 1.5rem; border: 1px solid #ddd; border-radius: 12px; }
    label { display:block; font-weight: 600; margin-bottom: .5rem; }
    input[type="text"] { width:100%; padding:.75rem; border:1px solid #ccc; border-radius:8px; }
    button { padding:.75rem 1rem; border:0; border-radius:10px; cursor:pointer; }
    .primary { background:#0ea5e9; color:white; }
    .ghost { background:#f6f6f6; }
    .row { display:flex; gap:.75rem; align-items:center; flex-wrap:wrap; }
    .mt { margin-top: 1rem; }
    code, pre { background:#f6f8fa; padding:.5rem .75rem; border-radius:8px; display:block; overflow:auto; }
    .ok { color: #16a34a; font-weight: 600; }
    .err { color: #dc2626; font-weight: 600; }
  </style>
  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
</head>
<body>
  <div class="card">
    <h2>Plaid Link — One-time Connect</h2>
    <p>Paste your <strong>link_token</strong> (from <code>link_token.txt</code>) and click <em>Link Bank</em>. On success, a <code>public_token</code> will appear below for the next step.</p>

    <label for="token">link_token</label>
    <input id="token" type="text" placeholder="link-token-..." />

    <div class="row mt">
      <button id="btn" class="primary">Link Bank</button>
      <button id="clear" class="ghost">Clear</button>
    </div>

    <div id="status" class="mt"></div>
    <div id="out" class="mt" style="display:none;">
      <h3 class="ok">Success — Copy this public_token</h3>
      <pre id="publicTokenBox"></pre>
      <button id="copy" class="ghost">Copy public_token</button>
      <p class="mt">Metadata (institution, accounts) for reference:</p>
      <pre id="metaBox"></pre>
    </div>

    <div id="error" class="mt" style="display:none;">
      <h3 class="err">Error</h3>
      <pre id="errorBox"></pre>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const btn = $("#btn");
    const clearBtn = $("#clear");
    const statusEl = $("#status");
    const out = $("#out");
    const error = $("#error");

    clearBtn.onclick = () => {
      $("#token").value = "";
      out.style.display = "none";
      error.style.display = "none";
      statusEl.textContent = "";
    };

    btn.onclick = () => {
      const linkToken = $("#token").value.trim();
      if (!linkToken) {
        statusEl.innerHTML = '<span class="err">Please paste your link_token first.</span>';
        return;
      }
      statusEl.textContent = "Opening Plaid Link...";
      error.style.display = "none";
      out.style.display = "none";

      const handler = Plaid.create({
        token: linkToken,
        onSuccess: function(public_token, metadata) {
          statusEl.innerHTML = '<span class="ok">Link success.</span>';
          $("#publicTokenBox").textContent = public_token;
          $("#metaBox").textContent = JSON.stringify(metadata, null, 2);
          out.style.display = "block";
          // Optional: alert as a backup
          // alert("public_token: " + public_token);
        },
        onExit: function(err, metadata) {
          if (err) {
            error.style.display = "block";
            $("#errorBox").textContent = JSON.stringify(err, null, 2);
            statusEl.innerHTML = '<span class="err">Link exited with error.</span>';
          } else {
            statusEl.textContent = "Link closed.";
          }
        }
      });

      handler.open();
    };

    $("#copy").onclick = async () => {
      const t = $("#publicTokenBox").textContent;
      try {
        await navigator.clipboard.writeText(t);
        alert("Copied public_token to clipboard.");
      } catch (e) {
        alert("Copy failed. Select and copy manually.");
      }
    };
  </script>
</body>
</html>
